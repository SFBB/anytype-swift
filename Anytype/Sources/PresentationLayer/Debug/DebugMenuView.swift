import SwiftUI
import AnytypeCore
import Logger

struct DebugMenuView: View {
    
    @StateObject private var model: DebugMenuViewModel
    
    @State private var showLogs = false
    @State private var showTypography = false
    @State private var showFeedbackGenerators = false
    @State private var showGradientIcons = false
    @State private var showControls = false
    @State private var showColors = false
    @State private var showObjectIcons = false
    @State private var showMembershipDebug = false
    
    init(spaceId: String? = nil) {
        _model = StateObject(wrappedValue: DebugMenuViewModel(spaceId: spaceId))
    }
    
    var body: some View {
        VStack {
            DragIndicator()
            VStack {
                AnytypeText("Debug menu üëª", style: .title)
                    .foregroundColor(.Text.primary)
                AnytypeText("Environment: \(BuildTypeProvider.buidType.rawValue)", style: .caption1Medium)
                    .foregroundColor(.Text.tertiary)
            }.padding()
            
            ScrollView {
                VStack(spacing: 0) {
                    buttonsMenu
                    Spacer.fixedHeight(20)
                    toggles
                    setPageCounter
                    currentVersionInput
                    removeKey
                }
            }
        }
        .background(Color.Background.primary)
        .navigationBarHidden(true)
        .embedInNavigation()
        
        .onAppear {
            rowsPerPageInSet = "\(model.userDefaults.rowsPerPageInSet)"
            currentVersion = model.userDefaults.currentVersionOverride
        }
    }
    
    private var buttonsMenu: some View {
        VStack {
            mainActions
            
            HStack {
                Menu {
                    moreActions
                } label: {
                    StandardButton("More actions ‚ÑπÔ∏è", style: .borderlessLarge) {}
                }
                
                Menu {
                    designSystem
                } label: {
                    StandardButton("Design system üíÖ", style: .borderlessLarge) {}
                }
            }
        }
        .padding(.horizontal)
        
        .sheet(isPresented: $showLogs) { LoggerUI.makeView() }
        .sheet(isPresented: $showTypography) { TypographyExample() }
        .sheet(isPresented: $showFeedbackGenerators) { FeedbackGeneratorExamplesView() }
        .sheet(isPresented: $showGradientIcons) { GradientIconsExamples() }
        .sheet(isPresented: $showControls) { ControlsExample() }
        .sheet(isPresented: $showColors) { ColorsExample() }
        .sheet(isPresented: $showObjectIcons) { ObjectIconExample() }
        .sheet(isPresented: $showMembershipDebug) { MembershipDebugView() }
        .sheet(item: $model.shareUrlFile) { url in
            ActivityViewController(activityItems: [url], applicationActivities: nil)
        }
        .sheet(isPresented: $model.showZipPicker) {
            DocumentPicker(contentTypes: [.zip]) { url in
                model.onSelectUnzipFile(url: url)
            }
        }
    }
    
    private var mainActions: some View {
        VStack {
            StandardButton("Logs üßª", style: .secondaryLarge) {
                showLogs.toggle()
            }
            
            StandardButton("Export localstore üìÅ", style: .secondaryLarge) {
                UIImpactFeedbackGenerator(style: .heavy).impactOccurred()
                model.getLocalStoreData()
            }
            
            if case .done(url: let url) = model.debugRunProfilerData {
                StandardButton("Download Debug Run Profiler Data üíø", style: .secondaryLarge) {
                    UIImpactFeedbackGenerator(style: .heavy).impactOccurred()
                    model.shareUrlContent(url: url)
                }
            }
        }
    }
    
    private var moreActions: some View {
        VStack {
            StandardButton("Crash üî•", style: .primaryLarge) {
                let crash: [Int] = []
                _ = crash[1]
            }
            StandardButton("Assert ü•≤", style: .secondaryLarge) {
                anytypeAssertionFailure("Test assert")
            }
            
            StandardButton("Membership debug üí∏", style: .secondaryLarge) {
                UISelectionFeedbackGenerator().selectionChanged()
                showMembershipDebug.toggle()
            }
            
            StandardButton("Debug stack Goroutines üí§", style: .secondaryLarge) {
                UIImpactFeedbackGenerator(style: .heavy).impactOccurred()
                model.getGoroutinesData()
            }
            if let spaceId = model.spaceId {
                AsyncStandardButton("Space debug ü™ê", style: .secondaryLarge) {
                    UIImpactFeedbackGenerator(style: .heavy).impactOccurred()
                    try await model.onSpaceDebug(spaceId: spaceId)
                }
            }
            StandardButton(model.debugRunProfilerData.text, style: .secondaryLarge) {
                UIImpactFeedbackGenerator(style: .heavy).impactOccurred()
                model.onDebugRunProfiler()
            }
    
            AsyncStandardButton("Debug stat ü´µüê≠", style: .secondaryLarge) {
                UIImpactFeedbackGenerator(style: .heavy).impactOccurred()
                try await model.debugStat()
            }
            
            StandardButton("Export full directory ü§ê", style: .secondaryLarge) {
                UIImpactFeedbackGenerator(style: .heavy).impactOccurred()
                model.zipWorkingDirectory()
            }
            StandardButton("Import full directory üì≤", style: .secondaryLarge) {
                UIImpactFeedbackGenerator(style: .heavy).impactOccurred()
                model.unzipWorkingDirectory()
            }
        }
    }
    
    private var designSystem: some View {
        VStack {
            StandardButton("Typography ü¶≠", style: .secondaryLarge) {
                showTypography.toggle()
            }
            
            StandardButton("Controls üéõÔ∏è", style: .secondaryLarge) {
                UIImpactFeedbackGenerator(style: .heavy).impactOccurred()
                showControls.toggle()
            }
            StandardButton("Space icons üü£", style: .secondaryLarge) {
                UIImpactFeedbackGenerator(style: .heavy).impactOccurred()
                showGradientIcons.toggle()
            }
            
            StandardButton("Colors üåà", style: .secondaryLarge) {
                UIImpactFeedbackGenerator(style: .heavy).impactOccurred()
                showColors.toggle()
            }
            
            StandardButton("Object icons üì∏", style: .secondaryLarge) {
                UIImpactFeedbackGenerator(style: .heavy).impactOccurred()
                showObjectIcons.toggle()
            }
            
            StandardButton("Feedback Generator üÉè", style: .secondaryLarge) {
                UIImpactFeedbackGenerator(style: .heavy).impactOccurred()
                showFeedbackGenerators.toggle()
            }
        }
    }
    
    
    @State private var expanded = true
    var toggles: some View {
        VStack(alignment: .leading, spacing: 0) {
            ForEach(model.flags, id: \.title) { section in
                DisclosureGroup(isExpanded: $expanded) {
                    VStack(spacing: 0) {
                        ForEach(section.rows, id: \.description.title) { row in
                            FeatureFlagView(model: row)
                        }
                    }
                } label: {
                    AnytypeText(section.title, style: .heading)
                        .foregroundColor(.Text.primary)
                        .padding()
                }
            }
        }
        .padding(.horizontal, 20)
        .background(UIColor.systemGroupedBackground.suColor)
        .cornerRadius(20, corners: .top)
    }
    
    @State var rowsPerPageInSet = ""
    private var setPageCounter: some View {
        DebugMenuInputSettings(
            title: "Number of rows per page in set",
            placeholder: "Pages",
            inputText: $rowsPerPageInSet
        )
        .onChange(of: rowsPerPageInSet) { count in
            guard let count = Int(count) else { return }
            model.userDefaults.rowsPerPageInSet = count
        }
    }
    
    @State var currentVersion = ""
    private var currentVersionInput: some View {
        DebugMenuInputSettings(
            title: "Custom current version for update banner (ex: 0.0.1)",
            placeholder: "Version",
            inputText: $currentVersion
        )
        .onChange(of: currentVersion) {
            model.userDefaults.currentVersionOverride = $0
        }
    }
    
    private var removeKey: some View {
        StandardButton(
            "Remove Key from device",
            inProgress: model.isRemovingRecoveryPhraseInProgress,
            style: .warningLarge
        ) {
            model.removeRecoveryPhraseFromDevice()
        }
        .padding()
        .background(UIColor.systemGroupedBackground.suColor)
        .cornerRadius(20, corners: .bottom)
    }
}

extension URL: @retroactive Identifiable {
    public var id: String { absoluteString }
}

#Preview {
    DebugMenuView()
}
