default_platform(:ios)

platform :ios do

  # Build from branch (only for local)

  lane :branch_build do |options| 

    ensure_git_status_clean(
      show_uncommitted_changes: true
    )

    xcodeproj = ENV["APP_PROJECT"]
    
    match(readonly: true)
    
    version = "0.0.1"
    build_number = "0"
    increment_version_number(version_number: version)
    increment_build_number(build_number: build_number, xcodeproj: xcodeproj)

    add_badge(
      shield: "#{version}-#{build_number}-blue",
      no_badge: true
    )

    build_app(
      scheme: ENV["APP_TARGET"], 
      configuration: ENV["APP_CONF_DEVELOP"],
      include_symbols: true,
      use_system_scm: true,
      archive_path: "./build/archive",
      output_directory: "./build/result",
      output_name: "Anytype.ipa",
      xcargs: ENV['BUILD_OPTIONS']
    )

    private_lane :upload_build_to_testflight do 
      api_key = app_store_connect_api_key(
          key_id: ENV['APP_STORE_CONNECT_KEY_ID'],
          issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
          key_content: ENV['APP_STORE_CONNECT_KEY_CONTENT'],
          duration: 1200,
          in_house: false
      )
  
      upload_to_testflight(
        api_key: api_key, 
        skip_waiting_for_build_processing: true
      )
    end

    reset_git_repo(skip_clean: true)

  end

end
